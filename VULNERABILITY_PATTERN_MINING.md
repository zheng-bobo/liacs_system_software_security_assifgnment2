# Vulnerability Pattern Mining Workflow Documentation

## Overview

This document describes the complete workflow for extracting and identifying recurring vulnerability code patterns from the MoreFixes database. The workflow combines multiple code representation methods and similarity features to automatically generate vulnerability pattern records that can be used for GitHub searches.

**Main Program**: `vulnerability_pattern_miner.py`

## Complete Workflow

### Step 1: Data Extraction

Extract high-quality vulnerability fix samples from the MoreFixes database.

**Function**: `extract_java_vulnerable_code()`  
**Location**: `vulnerability_pattern_miner.py`

**Filter Conditions**:
- `fixes.score >= 65` (high-quality fix samples, accuracy ~95%+, adjustable via `min_score` parameter)
- `COALESCE(file_change.diff, '') <> ''` (requires non-empty diff string, controllable via `require_diff` parameter, default True)
- `COALESCE(commits.merge, FALSE) = FALSE` (exclude merge commits, controllable via `exclude_merge_commits` parameter, default True)
- `file_change.code_before IS NOT NULL AND file_change.code_before <> 'None'` (requires valid code_before field)
- `LOWER(file_change.programming_language) = LOWER(:lang)` (programming language filter, case-insensitive matching, supports multiple languages, default Java)

**Extracted Fields**:
- `cve_id`: CVE ID
- `hash`: Commit hash
- `repo_url`: Repository URL
- `filename`: Filename
- `code_before`: **Pre-fix code** (pre-fix hunk, 3-8 lines of context)
- `code_after`: Post-fix code
- `diff`: Code differences
- `score`: Fix quality score

**Output**: `output/extract_java_vulnerable_code.csv`

---

### Step 2: Vulnerability Pattern Identification

Identify vulnerability patterns based on source/sink/taint analysis and security measure checks.

**Function**: `process_cwe_based_patterns()`  
**Location**: `vulnerability_pattern_miner.py`  
**Main Methods**: 
- `extract_vulnerability_pattern()` - Extract vulnerability patterns
- `analyze_source_sink_taint()` - Analyze source, sink, and taint flows
- `analyze_missing_security()` - Analyze missing security measures

#### 2.1 Get Method-Level Code Changes

**Function**: `get_method_changes_for_cve()`  
**Location**: `vulnerability_pattern_miner.py`

Extract method-level code change information for a specified CVE from the database.

**Extracted Fields**:
- `cve_id`: CVE ID
- `file_change_id`: File change ID
- `method_change_id`: Method change ID
- `method_name`: Method name
- `signature`: Method signature
- `before_change`: Pre-change code
- `code_after`: Post-change code
- `start_line`: Start line number
- `end_line`: End line number

#### 2.2 Source Identification (Untrusted Input Sources)

**Function**: Source pattern identification in `analyze_source_sink_taint()`

Identify untrusted input sources in code, including:

- **Servlet API**: `getParameter()`, `getHeader()`, `getQueryString()`, `getAttribute()`, `getCookies()`, etc.
- **Spring Framework**: `@RequestParam`, `@PathVariable`, `@RequestHeader`, `@RequestBody`
- **File Operations**: `new File()`, `Paths.get()`
- **Deserialization**: `readObject()`, `ObjectInputStream.readObject()`
- **System Properties**: `System.getenv()`, `System.getProperty()`
- **Command Line Arguments**: `args[]`

**Example**:
```java
String urlParam = request.getParameter("url");  // Source: getParameter
String header = request.getHeader("User-Agent"); // Source: getHeader
File file = new File(userInput);                // Source: newFile
```

#### 2.3 Sink Identification (Dangerous Usage Points)

**Function**: Sink pattern identification in `analyze_source_sink_taint()`

Identify dangerous usage points based on CWE type:

- **SQLi sinks**: `execute()`, `executeQuery()`, `executeUpdate()`, `createStatement()`
- **XSS sinks (CWE-79)**: `println()`, `print()`, `write()`, `append()`, `getWriter()`, `innerHTML`, `outerHTML`
- **Path Traversal sinks (CWE-22)**: `new File()`, `FileInputStream()`, `FileOutputStream()`, `Files.readAllBytes()`, `Paths.get()`
- **Command Injection sinks**: `Runtime.exec()`, `ProcessBuilder()`
- **Deserialization sinks**: `readObject()`, `ObjectInputStream.readObject()`

**Example**:
```java
statement.execute(sql);              // SQLi sink
response.getWriter().print(param);   // XSS sink
new File(userPath);                  // Path Traversal sink
Runtime.getRuntime().exec(cmd);      // Command Injection sink
```

#### 2.4 Taint Flow Analysis

**Function**: Taint flow tracking in `analyze_source_sink_taint()`

Track data propagation paths from source to sink:

1. Identify source and mark variables as tainted
2. Track usage of tainted variables in code
3. Check if tainted variables reach sink
4. Establish source → variable → sink taint flow

**Example**:
```java
String param = request.getParameter("input");  // Source: param marked as tainted
String processed = param.trim();                 // processed is also tainted
response.getWriter().print(processed);          // Taint flow: param → processed → sink
```

#### 2.5 Security Measures Analysis

**Function**: `analyze_missing_security()`

Compare pre-fix and post-fix code to identify missing security measures:

- **PreparedStatement**: SQL injection protection
- **escapeHtml**: XSS protection (CWE-79)
- **normalize**: Path normalization (CWE-22)
- **pathValidation**: Path validation (CWE-22)
- **ObjectInputFilter**: Deserialization protection
- **validation**: Input validation
- **whitelist**: Whitelist filtering
- **sanitize**: Data sanitization

**Analysis Logic**:
- Check if security measures are missing in pre-fix code
- Check if security measures are added in post-fix code
- If missing in pre-fix and added in post-fix, mark as missing security measures

**Example**:
```java
// Pre-fix (missing security measures)
response.getWriter().print(userInput);

// Post-fix (security measures added)
response.getWriter().print(StringEscapeUtils.escapeHtml(userInput));
// Identification result: missing_sanitizers = ["escapeHtml"]
```

#### 2.6 Pattern Extraction and Filtering

**Function**: `extract_vulnerability_pattern()`

Comprehensively extract vulnerability patterns based on source/sink/taint analysis and security measure checks.

**Filter Conditions** (based on CWE type):
- **CWE-79 (XSS)** and **CWE-22 (Path Traversal)**: Require complete taint flow (source + sink + taint flow)
- **NVD-CWE-noinfo**: Relaxed conditions, only require source and sink

**Output Pattern Fields**:
- `sources`: Source list
- `sinks`: Sink list
- `taint_flows`: Taint flow list
- `tainted_variables`: Set of tainted variables
- `missing_sanitizers`: List of missing security measures
- `added_security_measures`: List of added security measures
- `pattern_summary`: Pattern summary (has_source, has_sink, has_taint_flow, missing_security)

---

### Step 3: GitHub Query Generation

Generate GitHub search query keywords for each vulnerability pattern.

**Class**: `GitHubQueryGenerator`  
**Location**: `github_query_generator.py`  
**Method**: `generate_github_search_keywords(patterns_df, output_dir, top_n, save_file)`

#### 3.1 Keyword Extraction

**Method**: `_generate_github_search_keywords(pattern, cwe_id)`

Generate search keywords based on source and sink information from vulnerability patterns:

**Source Keyword Extraction**:
- Extract source types from `pattern["sources"]`
- Common source keywords: `getParameter`, `getHeader`, `readObject`, `new File`, etc.

**Sink Keyword Extraction** (optimized by CWE type):
- **CWE-79 (XSS)**: `println`, `response.getWriter`, `innerHTML`, etc.
- **CWE-22 (Path Traversal)**: `new File`, `Files.readAllBytes`, `Paths.get`, etc.
- **SQLi**: `execute`, `executeQuery`, `createStatement`, etc.
- **Command Injection**: `Runtime.exec`, `ProcessBuilder`, etc.

#### 3.2 Query Construction

**Query Format**:
```
(source_keyword OR source_keyword) (sink_keyword OR sink_keyword) language:java
```

**Example**:
```
(getParameter OR getHeader) (println OR response.getWriter) language:java
(new File OR Paths.get) (Files.readAllBytes OR FileInputStream) language:java
```

#### 3.3 Output Format

**Output File**: `output/recurring_patterns_top{n}.csv`

**Fields**:
- `cwe_id`: CWE ID
- `cwe_name`: CWE name
- `cve_id`: CVE ID
- `file_change_id`: File change ID
- `method_change_id`: Method change ID
- `method_name`: Method name
- `sources`: Source list (string format)
- `sinks`: Sink list (string format)
- `taint_flows`: Taint flow list (string format)
- `missing_sanitizers`: Missing security measures list (string format)
- `github_search_keywords`: GitHub search query keywords
- `method_code`: Method code snippet (first 500 characters)

---

## Complete Workflow

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: Data Extraction                                     │
│ extract_java_vulnerable_code()                              │
│ - Extract high-quality vulnerability fix samples from DB    │
│ - Filter conditions: score >= 65, diff non-empty,          │
│   merge = FALSE, code_before valid, language filter        │
│   (case-insensitive)                                        │
│ - Optional: Filter top n CWE                                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: Vulnerability Pattern Identification                │
│ process_cwe_based_patterns()                               │
│ - Get method-level code changes                            │
│ - Source/Sink/Taint Analysis                               │
│ - Security measures analysis (compare pre/post-fix)        │
│ - Pattern extraction and filtering (based on CWE type)     │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: GitHub Query Generation                            │
│ GitHubQueryGenerator.generate_github_search_keywords()      │
│ - Extract keywords from source/sink                       │
│ - Optimize queries based on CWE type                       │
│ - Generate GitHub search query strings                     │
└─────────────────────────────────────────────────────────────┘
```

## Usage

### Command Line Usage

```bash
# Extract top 10 most common vulnerability patterns
python vulnerability_pattern_miner.py --top-n 10 --min-score 65 --languages java

# Support multiple languages
python vulnerability_pattern_miner.py --top-n 3 --languages java javascript python

# Include merge commits
python vulnerability_pattern_miner.py --top-n 3 --include-merge --languages java
```

### Python API Usage

```python
from vulnerability_pattern_miner import (
    DatabaseConnector,
    extract_java_vulnerable_code,
    process_cwe_based_patterns,
)
from github_query_generator import GitHubQueryGenerator
from pathlib import Path

# 1. Connect to database
db_connector = DatabaseConnector()

# 2. Extract vulnerable code (optional: filter top n CWE)
vulnerable_code_df = extract_java_vulnerable_code(
    db_connector,
    min_score=65,
    exclude_merge_commits=True,
    programming_languages=["Java"],
    require_diff=True,
    top_n=3,  # Optional: only extract data for top 3 CWE
)

# 3. Identify vulnerability patterns (CWE-based source/sink/taint analysis)
patterns_df = process_cwe_based_patterns(
    vulnerable_code_df,
    db_connector,
    top_n=3,
    min_score=65,
    programming_languages=["Java"],
    output_dir=Path("output"),
)

# 4. Generate GitHub queries
if len(patterns_df) > 0:
    query_generator = GitHubQueryGenerator()
    patterns_df = query_generator.generate_github_search_keywords(
        patterns_df,
        output_dir=Path("output"),
        top_n=3,
        save_file=True,
    )
```

## Output Files

1. **`output/extract_java_vulnerable_code.csv`**
   - Extracted vulnerability code data
   - Contains: cve_id, hash, repo_url, filename, score, programming_language, and other metadata

2. **`output/top_cwe_top{n}.csv`**
   - Top N CWE list
   - Contains: cwe_id, cwe_name

3. **`output/recurring_patterns_top{n}.csv`**
   - Vulnerability pattern records (includes GitHub query keywords)
   - Contains: cwe_id, cwe_name, cve_id, file_change_id, method_change_id, method_name, sources, sinks, taint_flows, missing_sanitizers, github_search_keywords, method_code, and other fields

## Technical Details

### Source/Sink/Taint Analysis Flow

```
Method Code
  ↓
Source Identification (regex matching)
  - Identify untrusted input sources (getParameter, getHeader, etc.)
  - Mark variables as tainted
  ↓
Sink Identification (regex matching)
  - Identify dangerous usage points (execute, println, new File, etc.)
  - Filter relevant sinks based on CWE type
  ↓
Taint Flow Tracking
  - Track propagation of tainted variables in code
  - Check if tainted variables reach sink
  - Establish source → variable → sink taint flow
  ↓
Multi-round Taint Propagation Analysis
  - Assignment propagation: x = tainted_var
  - String concatenation propagation: sql = "SELECT" + tainted_var
  - StringBuilder propagation: sb.append(tainted_var)
```

### Security Measures Analysis Flow

```
Pre-fix Code + Post-fix Code
  ↓
Comparative Analysis
  - Check if security measures are missing in pre-fix
  - Check if security measures are added in post-fix
  ↓
Identify Missing Security Measures
  - PreparedStatement (SQLi protection)
  - escapeHtml (XSS protection)
  - normalize (path normalization)
  - pathValidation (path validation)
  - etc.
```

### GitHub Query Generation Flow

```
Vulnerability Pattern (contains sources, sinks, cwe_id)
  ↓
Extract Source Keywords
  - Extract keywords from sources list
  - Common: getParameter, getHeader, readObject, etc.
  ↓
Extract Sink Keywords (based on CWE type)
  - CWE-79: println, response.getWriter, innerHTML
  - CWE-22: new File, Files.readAllBytes, Paths.get
  - SQLi: execute, executeQuery, createStatement
  ↓
Build Query String
  - Format: (source1 OR source2) (sink1 OR sink2) language:java
```

## Performance Optimization

1. **CWE Filtering**: Use `top_n` parameter to only process most common CWE types, reducing processing volume
2. **Batch Queries**: Fetch CWE classification information in one go, avoiding repeated database queries
3. **Regex Optimization**: Use compiled regex patterns for efficient matching
4. **Taint Propagation Limits**: Limit maximum iterations of taint propagation (default 5), avoiding infinite loops

## Notes

1. **Language Support**: 
   - Currently mainly supports Java language
   - Source/Sink patterns optimized for common Java APIs
   - Other languages may require extending source/sink patterns

2. **CWE Types**: 
   - Supports targeted analysis for specific CWE types (CWE-79, CWE-22, etc.)
   - For `NVD-CWE-noinfo`, relaxed filter conditions (only require source + sink)

3. **Taint Flow Analysis**: 
   - Uses regex for approximate analysis, may not capture all complex control flows
   - Multi-round propagation analysis may produce false positives

4. **GitHub API Limits**: 
   - Requires GitHub Personal Access Token (optional but recommended)
   - Note API rate limit (unauthenticated: 60/hour, authenticated: 5000/hour)

5. **Database Connection**: 
   - Requires database connection configuration (via environment variables or `.env` file)

## Example Output

### Recurring Pattern Example

```csv
cwe_id,cwe_name,cve_id,method_name,sources,sinks,github_search_keywords
CWE-79,Cross-site Scripting (XSS),CVE-2021-xxxx,processRequest,"[{'variable': 'param', 'type': 'getParameter'}]","[{'sink_name': 'println', 'vuln_type': 'XSS'}]","(getParameter OR getHeader) (println OR response.getWriter) language:java"
CWE-22,Path Traversal,CVE-2022-yyyy,readFile,"[{'variable': 'path', 'type': 'newFile'}]","[{'sink_name': 'FileInputStream', 'vuln_type': 'PathTraversal'}]","(new File OR Paths.get) (Files.readAllBytes OR FileInputStream) language:java"
```

## Related Files

- `vulnerability_pattern_miner.py`: Main program file (includes data extraction and pattern identification)
- `github_query_generator.py`: GitHub query generation module
- `DATABASE_TABLES_EXPLANATION.md`: Database table structure documentation
- `README.md`: Project overview documentation
